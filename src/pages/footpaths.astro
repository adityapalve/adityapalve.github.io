---
import BaseLayout from '../layouts/BaseLayout.astro';
import footpaths from '../data/footpaths.json';

// Convert footpaths to JSON for the client-side script
const footpathsData = JSON.stringify(footpaths);
---

<BaseLayout title="Footpaths â€“ Aditya Palve">
  <h1>Footpaths</h1>
  
  <p class="muted">
    Places I've wandered. Click a marker to see photos from that location.
  </p>

  <div id="map-container">
    <div id="map"></div>
  </div>

  <div id="photo-modal" class="modal">
    <div class="modal-content">
      <button class="modal-close" aria-label="Close">&times;</button>
      <div class="modal-header">
        <h3 id="modal-location"></h3>
        <span id="modal-date" class="muted small"></span>
      </div>
      <div id="modal-photos"></div>
    </div>
  </div>

  <hr />

  <h2>Location List</h2>
  <ul class="location-list">
    {footpaths.map(fp => (
      <li>
        <span class="date muted small">{fp.date}</span>
        <button class="location-link" data-id={fp.id}>
          {fp.location}
        </button>
        <span class="muted small">â€” {fp.photos.length} photo{fp.photos.length !== 1 ? 's' : ''}</span>
      </li>
    ))}
  </ul>

  <hr />

  <p class="muted small">
    <strong>How this works:</strong> I export photos from my iPhone, extract GPS coordinates 
    from the EXIF data, and compile them into a data file that powers this map. 
    Eventually, I'd like to automate this with an iOS Shortcut.
  </p>
</BaseLayout>

<style>
  #map-container {
    margin: 1.5rem 0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  #map {
    width: 100%;
    height: 400px;
    background: #e0e0e0;
  }

  .location-list {
    list-style: none;
    padding-left: 0;
  }

  .location-list li {
    margin-bottom: 0.75rem;
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .location-list .date {
    min-width: 90px;
  }

  .location-link {
    background: none;
    border: none;
    color: var(--color-link);
    cursor: pointer;
    font-family: inherit;
    font-size: inherit;
    padding: 0;
    text-decoration: none;
  }

  .location-link:hover {
    color: var(--color-link-hover);
    text-decoration: underline;
  }

  /* Modal styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .modal.active {
    display: flex;
  }

  .modal-content {
    background: var(--color-bg);
    border-radius: 8px;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    padding: 1.5rem;
  }

  .modal-close {
    position: absolute;
    top: 0.75rem;
    right: 1rem;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-muted);
    line-height: 1;
  }

  .modal-close:hover {
    color: var(--color-text);
  }

  .modal-header {
    margin-bottom: 1rem;
  }

  .modal-header h3 {
    margin: 0;
  }

  #modal-photos {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  #modal-photos .photo-item {
    text-align: center;
  }

  #modal-photos img {
    max-width: 100%;
    border-radius: 4px;
  }

  #modal-photos .photo-caption {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: var(--color-muted);
  }

  /* Placeholder for when no photo exists */
  .photo-placeholder {
    background: linear-gradient(135deg, #667 0%, #445 100%);
    width: 100%;
    aspect-ratio: 4/3;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.9rem;
  }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" is:inline></script>

<script define:vars={{ footpathsData }}>
  const footpaths = JSON.parse(footpathsData);
  
  // Initialize map
  document.addEventListener('DOMContentLoaded', () => {
    // Create map centered on a middle point
    const map = L.map('map').setView([30, 0], 2);
    
    // Add tile layer (using CartoDB's light tiles for minimal aesthetic)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
      maxZoom: 19
    }).addTo(map);
    
    // Add markers for each location
    const markers = {};
    footpaths.forEach(fp => {
      const marker = L.marker([fp.lat, fp.lng])
        .addTo(map)
        .bindPopup(`<strong>${fp.location}</strong><br><small>${fp.date}</small>`);
      
      marker.on('click', () => openModal(fp));
      markers[fp.id] = marker;
    });
    
    // Fit bounds to show all markers
    if (footpaths.length > 0) {
      const bounds = L.latLngBounds(footpaths.map(fp => [fp.lat, fp.lng]));
      map.fitBounds(bounds, { padding: [30, 30] });
    }
    
    // Modal functionality
    const modal = document.getElementById('photo-modal');
    const modalLocation = document.getElementById('modal-location');
    const modalDate = document.getElementById('modal-date');
    const modalPhotos = document.getElementById('modal-photos');
    const modalClose = document.querySelector('.modal-close');
    
    function openModal(footpath) {
      modalLocation.textContent = footpath.location;
      modalDate.textContent = footpath.date;
      
      modalPhotos.innerHTML = footpath.photos.map(photo => `
        <div class="photo-item">
          <div class="photo-placeholder">
            ðŸ“· Photo: ${photo.caption}
          </div>
          <p class="photo-caption">${photo.caption}</p>
        </div>
      `).join('');
      
      modal.classList.add('active');
    }
    
    function closeModal() {
      modal.classList.remove('active');
    }
    
    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });
    
    // Location list click handlers
    document.querySelectorAll('.location-link').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const footpath = footpaths.find(fp => fp.id === id);
        if (footpath) {
          map.setView([footpath.lat, footpath.lng], 12);
          markers[id].openPopup();
          openModal(footpath);
        }
      });
    });
  });
</script>
